{"version":3,"sources":["assets/scripts/components/InvitationHelper.js"],"names":["Log","require","cc","Class","Component","properties","onLoad","Trace","dgame","invitation","InvitationCode","TotalReward","InvitedNum","FailCount","game","addPersistRootNode","node","onDestroy","unschedule","_onCheckTimer","startCheck","settings","account","LoginCount","scheduleOnce","schedule","net","gameCall","_onGetInvitationCode","bind","_onHashData","hash","CandidateInvitationCodeSource","CandidateInvitationCode","substr","toUpperCase","applycode_cmd","JSON","stringify","_onApplyInvitationCode","err","normalLoading","showLoadTimeout","hashdata_cmd","Data","_onInviter","invitationCode","InviterInvitationCode","obj","Addr","start"],"mappings":";;;;;;AAAA,IAAIA,GAAG,GAAGC,OAAO,CAAC,KAAD,CAAjB;;AAEAC,EAAE,CAACC,KAAH,CAAS;AACL,aAASD,EAAE,CAACE,SADP;AAGLC,EAAAA,UAAU,EAAE,EAHP;AAML;AACAC,EAAAA,MAPK,oBAOK;AACNN,IAAAA,GAAG,CAACO,KAAJ,CAAU,yBAAV;;AACA,QAAI,CAACL,EAAE,CAACM,KAAR,EAAe;AACX;AACH;;AACDN,IAAAA,EAAE,CAACM,KAAH,CAASC,UAAT,GAAsB,IAAtB;AACAP,IAAAA,EAAE,CAACM,KAAH,CAASC,UAAT,CAAoBC,cAApB,GAAqC,EAArC;AACAR,IAAAA,EAAE,CAACM,KAAH,CAASC,UAAT,CAAoBE,WAApB,GAAkC,CAAlC;AACAT,IAAAA,EAAE,CAACM,KAAH,CAASC,UAAT,CAAoBG,UAApB,GAAiC,CAAjC;AACAV,IAAAA,EAAE,CAACM,KAAH,CAASC,UAAT,CAAoBI,SAApB,GAAgC,CAAhC;AACAX,IAAAA,EAAE,CAACY,IAAH,CAAQC,kBAAR,CAA2B,KAAKC,IAAhC;AACH,GAlBI;AAoBLC,EAAAA,SApBK,uBAoBQ;AACTjB,IAAAA,GAAG,CAACO,KAAJ,CAAU,4BAAV;AACA,SAAKW,UAAL,CAAgB,KAAKC,aAArB;;AACA,QAAI,CAAC,CAACjB,EAAE,CAACM,KAAT,EAAgB;AACZN,MAAAA,EAAE,CAACM,KAAH,CAASC,UAAT,GAAsB,IAAtB;AACH;AACJ,GA1BI;AA4BLW,EAAAA,UA5BK,wBA4BS;AACVpB,IAAAA,GAAG,CAACO,KAAJ,CAAU,wEAAwEL,EAAE,CAACM,KAAH,CAASa,QAAT,CAAkBC,OAAlB,CAA0BC,UAA5G;;AACA,QAAIrB,EAAE,CAACM,KAAH,CAASa,QAAT,CAAkBC,OAAlB,CAA0BC,UAA1B,IAAwC,CAA5C,EAA+C;AAC3C,WAAKC,YAAL,CAAkB,KAAKL,aAAvB,EAAsC,CAAtC;AACH,KAFD,MAEO;AACH,WAAKA,aAAL;AACH;;AACD,SAAKM,QAAL,CAAc,KAAKN,aAAnB,EAAkC,EAAlC;AACH,GApCI;AAsCLA,EAAAA,aAtCK,2BAsCY;AACbjB,IAAAA,EAAE,CAACM,KAAH,CAASkB,GAAT,CAAaC,QAAb,CAAsB,CAAC,SAAD,EAAY,EAAZ,CAAtB,EAAuC,KAAKC,oBAAL,CAA0BC,IAA1B,CAA+B,IAA/B,CAAvC;AACH,GAxCI;AA0CLC,EAAAA,WA1CK,uBA0CQC,IA1CR,EA0Cc;AACf/B,IAAAA,GAAG,CAACO,KAAJ,CAAU,4BAA4BL,EAAE,CAACM,KAAH,CAASC,UAAT,CAAoBuB,6BAAhD,GAAgF,MAAhF,GAAyFD,IAAnG;AACA7B,IAAAA,EAAE,CAACM,KAAH,CAASC,UAAT,CAAoBuB,6BAApB,GAAoDD,IAApD;AACA7B,IAAAA,EAAE,CAACM,KAAH,CAASC,UAAT,CAAoBwB,uBAApB,GAA8C/B,EAAE,CAACM,KAAH,CAASC,UAAT,CAAoBuB,6BAApB,CAAkDE,MAAlD,CAAyD,CAAzD,EAA4D,CAA5D,EAA+DC,WAA/D,EAA9C;AACA,QAAIC,aAAa,GAAG;AAChB1B,MAAAA,cAAc,EAAER,EAAE,CAACM,KAAH,CAASC,UAAT,CAAoBwB;AADpB,KAApB;AAGA/B,IAAAA,EAAE,CAACM,KAAH,CAASkB,GAAT,CAAaC,QAAb,CAAsB,CAAC,WAAD,EAAcU,IAAI,CAACC,SAAL,CAAeF,aAAf,CAAd,CAAtB,EAAoE,KAAKG,sBAAL,CAA4BV,IAA5B,CAAiC,IAAjC,CAApE;AACH,GAlDI;AAoDLU,EAAAA,sBApDK,kCAoDmBC,GApDnB,EAoDwB;AACzBxC,IAAAA,GAAG,CAACO,KAAJ,CAAU,oCAAoCiC,GAA9C;;AACA,QAAIA,GAAG,IAAI,sBAAX,EAAmC;AAC/BtC,MAAAA,EAAE,CAACM,KAAH,CAASiC,aAAT,CAAuBC,eAAvB;AACA;AACH;;AAED,QAAIF,GAAG,IAAI,EAAX,EAAe;AACXtC,MAAAA,EAAE,CAACM,KAAH,CAASC,UAAT,CAAoBC,cAApB,GAAqCR,EAAE,CAACM,KAAH,CAASC,UAAT,CAAoBwB,uBAAzD;AACA,aAAO/B,EAAE,CAACM,KAAH,CAASC,UAAT,CAAoBwB,uBAA3B;AACA,aAAO/B,EAAE,CAACM,KAAH,CAASC,UAAT,CAAoBuB,6BAA3B;AACH,KAJD,MAIO;AACH,UAAIW,YAAY,GAAG;AACfC,QAAAA,IAAI,EAAE1C,EAAE,CAACM,KAAH,CAASC,UAAT,CAAoBuB;AADX,OAAnB;AAGA9B,MAAAA,EAAE,CAACM,KAAH,CAASkB,GAAT,CAAaC,QAAb,CAAsB,CAAC,UAAD,EAAaU,IAAI,CAACC,SAAL,CAAeK,YAAf,CAAb,CAAtB,EAAkE,KAAKb,WAAL,CAAiBD,IAAjB,CAAsB,IAAtB,CAAlE;AACH;AACJ,GArEI;AAuELgB,EAAAA,UAvEK,sBAuEOC,cAvEP,EAuEuB;AACxB9C,IAAAA,GAAG,CAACO,KAAJ,CAAU,kBAAkBuC,cAA5B;;AACA,QAAIA,cAAc,IAAI,sBAAtB,EAA8C;AAC1C5C,MAAAA,EAAE,CAACM,KAAH,CAASiC,aAAT,CAAuBC,eAAvB;AACA;AACH;;AACDxC,IAAAA,EAAE,CAACM,KAAH,CAASC,UAAT,CAAoBsC,qBAApB,GAA4CD,cAA5C;AACH,GA9EI;AAgFLlB,EAAAA,oBAhFK,gCAgFiBoB,GAhFjB,EAgFsB;AACvBhD,IAAAA,GAAG,CAACO,KAAJ,CAAU,4BAA4B8B,IAAI,CAACC,SAAL,CAAeU,GAAf,CAAtC;;AACA,QAAIA,GAAG,IAAI,sBAAX,EAAmC;AAC/B9C,MAAAA,EAAE,CAACM,KAAH,CAASiC,aAAT,CAAuBC,eAAvB;AACA;AACH;;AACD,QAAIM,GAAG,CAACtC,cAAJ,IAAsB,EAA1B,EAA8B;AAC1B;AACAR,MAAAA,EAAE,CAACM,KAAH,CAASC,UAAT,CAAoBI,SAApB;AACAb,MAAAA,GAAG,CAACO,KAAJ,CAAU,uCAAuCL,EAAE,CAACM,KAAH,CAASC,UAAT,CAAoBI,SAArE;;AACA,UAAIX,EAAE,CAACM,KAAH,CAASC,UAAT,CAAoBI,SAApB,GAAgC,EAApC,EAAwC;AACpCX,QAAAA,EAAE,CAACM,KAAH,CAASC,UAAT,CAAoBuB,6BAApB,GAAoD9B,EAAE,CAACM,KAAH,CAASa,QAAT,CAAkBC,OAAlB,CAA0B2B,IAA1B,CAA+Bf,MAA/B,CAAsC,CAAtC,CAApD;AACAhC,QAAAA,EAAE,CAACM,KAAH,CAASC,UAAT,CAAoBwB,uBAApB,GAA8C/B,EAAE,CAACM,KAAH,CAASC,UAAT,CAAoBuB,6BAApB,CAAkDE,MAAlD,CAAyD,CAAzD,EAA4D,CAA5D,EAA+DC,WAA/D,EAA9C;AACA,YAAIC,aAAa,GAAG;AAChB1B,UAAAA,cAAc,EAAER,EAAE,CAACM,KAAH,CAASC,UAAT,CAAoBwB;AADpB,SAApB;AAGA/B,QAAAA,EAAE,CAACM,KAAH,CAASkB,GAAT,CAAaC,QAAb,CAAsB,CAAC,WAAD,EAAcU,IAAI,CAACC,SAAL,CAAeF,aAAf,CAAd,CAAtB,EAAoE,KAAKG,sBAAL,CAA4BV,IAA5B,CAAiC,IAAjC,CAApE;AACH;AACJ,KAZD,MAYO;AACH3B,MAAAA,EAAE,CAACM,KAAH,CAASC,UAAT,CAAoBC,cAApB,GAAqCsC,GAAG,CAACtC,cAAzC;AACAR,MAAAA,EAAE,CAACM,KAAH,CAASC,UAAT,CAAoBE,WAApB,GAAkCqC,GAAG,CAACrC,WAAtC;AACAT,MAAAA,EAAE,CAACM,KAAH,CAASC,UAAT,CAAoBG,UAApB,GAAiCoC,GAAG,CAACpC,UAArC;AACAV,MAAAA,EAAE,CAACM,KAAH,CAASkB,GAAT,CAAaC,QAAb,CAAsB,CAAC,SAAD,EAAY,EAAZ,CAAtB,EAAuC,KAAKkB,UAAL,CAAgBhB,IAAhB,CAAqB,IAArB,CAAvC;AACH;AACJ,GAxGI;AA0GLqB,EAAAA,KA1GK,mBA0GI,CAER,CA5GI,CA8GL;;AA9GK,CAAT","sourceRoot":"/","sourcesContent":["var Log = require(\"Log\");\n\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n    },\n\n    // LIFE-CYCLE CALLBACKS:\n    onLoad () {\n        Log.Trace(\"InvitationHelper:onLoad\");\n        if (!cc.dgame) {\n            return;\n        }\n        cc.dgame.invitation = this;\n        cc.dgame.invitation.InvitationCode = \"\";\n        cc.dgame.invitation.TotalReward = 0;\n        cc.dgame.invitation.InvitedNum = 0;\n        cc.dgame.invitation.FailCount = 0;\n        cc.game.addPersistRootNode(this.node);\n    },\n\n    onDestroy () {\n        Log.Trace(\"InvitationHelper:onDestroy\");\n        this.unschedule(this._onCheckTimer);\n        if (!!cc.dgame) {\n            cc.dgame.invitation = null;\n        }\n    },\n\n    startCheck () {\n        Log.Trace(\"invitationHelper startCheck, cc.dgame.settings.account.LoginCount: \" + cc.dgame.settings.account.LoginCount);\n        if (cc.dgame.settings.account.LoginCount == 0) {\n            this.scheduleOnce(this._onCheckTimer, 5);\n        } else {\n            this._onCheckTimer();\n        }\n        this.schedule(this._onCheckTimer, 60);\n    },\n\n    _onCheckTimer () {\n        cc.dgame.net.gameCall([\"getCode\", \"\"], this._onGetInvitationCode.bind(this));\n    },\n\n    _onHashData (hash) {\n        Log.Trace(\"[_onHashData] hashData(\" + cc.dgame.invitation.CandidateInvitationCodeSource + \") = \" + hash);\n        cc.dgame.invitation.CandidateInvitationCodeSource = hash;\n        cc.dgame.invitation.CandidateInvitationCode = cc.dgame.invitation.CandidateInvitationCodeSource.substr(0, 6).toUpperCase();\n        var applycode_cmd = {\n            InvitationCode: cc.dgame.invitation.CandidateInvitationCode,\n        }\n        cc.dgame.net.gameCall([\"applyCode\", JSON.stringify(applycode_cmd)], this._onApplyInvitationCode.bind(this));\n    },\n\n    _onApplyInvitationCode (err) {\n        Log.Trace(\"[_onApplyInvitationCode] err = \" + err);\n        if (err == \"Network disconnected\") {\n            cc.dgame.normalLoading.showLoadTimeout();\n            return;\n        }\n\n        if (err == \"\") {\n            cc.dgame.invitation.InvitationCode = cc.dgame.invitation.CandidateInvitationCode;\n            delete cc.dgame.invitation.CandidateInvitationCode;\n            delete cc.dgame.invitation.CandidateInvitationCodeSource;\n        } else {\n            var hashdata_cmd = {\n                Data: cc.dgame.invitation.CandidateInvitationCodeSource,\n            }\n            cc.dgame.net.gameCall([\"hashData\", JSON.stringify(hashdata_cmd)], this._onHashData.bind(this));\n        }\n    },\n\n    _onInviter (invitationCode) {\n        Log.Trace(\"[_onInviter] \" + invitationCode);\n        if (invitationCode == \"Network disconnected\") {\n            cc.dgame.normalLoading.showLoadTimeout();\n            return;\n        }\n        cc.dgame.invitation.InviterInvitationCode = invitationCode;\n    },\n\n    _onGetInvitationCode (obj) {\n        Log.Trace(\"[_onGetInvitationCode] \" + JSON.stringify(obj));\n        if (obj == \"Network disconnected\") {\n            cc.dgame.normalLoading.showLoadTimeout();\n            return;\n        }\n        if (obj.InvitationCode == \"\") {\n            //没有邀请码，先申请一个，种子为账号地址，申请失败出现重复再对种子进行哈希，哈希后的结果做为新的种子\n            cc.dgame.invitation.FailCount++;\n            Log.Trace(\"[_onGetInvitationCode] FailCount: \" + cc.dgame.invitation.FailCount);\n            if (cc.dgame.invitation.FailCount < 10) {\n                cc.dgame.invitation.CandidateInvitationCodeSource = cc.dgame.settings.account.Addr.substr(2);\n                cc.dgame.invitation.CandidateInvitationCode = cc.dgame.invitation.CandidateInvitationCodeSource.substr(0, 6).toUpperCase();\n                var applycode_cmd = {\n                    InvitationCode: cc.dgame.invitation.CandidateInvitationCode,\n                }\n                cc.dgame.net.gameCall([\"applyCode\", JSON.stringify(applycode_cmd)], this._onApplyInvitationCode.bind(this));\n            }\n        } else {\n            cc.dgame.invitation.InvitationCode = obj.InvitationCode;\n            cc.dgame.invitation.TotalReward = obj.TotalReward;\n            cc.dgame.invitation.InvitedNum = obj.InvitedNum;\n            cc.dgame.net.gameCall([\"inviter\", \"\"], this._onInviter.bind(this));\n        }\n    },\n\n    start () {\n\n    },\n\n    // update (dt) {},\n});\n"]}